<div id="heads">
    <th:block th:replace="usr/common/head"/>
</div>
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script async defer th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${GOOGLE_ROUTE_API_KEY} + '&callback=initMap1&libraries=places'"></script>
    <title>ê¸€ ì‘ì„±</title>
    <style>
        html {
            background-color: #FFFEF0;
            color: #4D3E3E;
        }
        .title{
            text-align: center;
            padding-top: 70px;
            font-size: 50px;
        }
        .writewalk{
            border: 1px solid #ccc;
            border-radius: 10px;
            width: 80%;
            margin-left: 10%;
            padding: 20px;
        }
        .enterMap {
            padding-left: 10px;
            padding-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #F2F2EB;
            width: 400px;
            height: 50px;
            display: inline-block;
        }
        .WalkingTrail, .WalkingSchedule {
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #F2F2EB;
            display: inline-block;
            width: 400px;
            height: 400px;
        }
        .buttons{
            margin-left: 80%;
        }
        #clearPathButton, #showlist{
            border: 1px solid #ccc;
            border-radius: 10px;
            width: 90px;
            height: 40px;
        }
        th{
            width: 24%;
        }
    </style>
</head>
<body>
<div class="title">ì‚°ì±… ì¼ì§€ ì‘ì„±</div>
<div class="writewalk">
    <label for="routeName">ì‚°ì±…ëª…</label>
    <input type="text" id="routeName" class="tw-border-box tw-w-[190px] tw-text-center tw-rounded-[5px] tw-border" /><br/><br/>
    <label for="scheduleDate">ì‚°ì±… ë‚ ì§œ ì„ íƒ</label>
    <input type="date" id="scheduleDate" class="tw-border-box tw-w-[190px] tw-text-center tw-rounded-[5px] tw-border" /><br/><br/>
    <div class="enterMap">
        <input type="text" id="locationInput" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" />
        <button onclick="searchLocation()">ì°¿ê¸°</button>
    </div><br/><br/>
    <div class="WalkingTrail" id="walkingTrailMap"></div>
    <div class="WalkingSchedule">
        <table id="WalkingTable">
            <thead>
            <tr>
                <th id="routeNameHeader">ì‚°ì±…ëª…<span class="sort-arrow" id="routeNameArrow"></span></th>
                <th id="purchaseDateHeader">ì‚°ì±… ë‚ ì§œ<span class="sort-arrow" id="purchaseDateArrow">â–²</span></th>
                <th id="routedistanceHeader">ì‚°ì±… ê±°ë¦¬<span class="sort-arrow" id="routedistanceArrow"></span></th>
                <th id="modifyHeader">ì¦ê²¨ì°¾ê¸°</th>
            </tr>
            </thead>
            <tbody>
            <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </tbody>
        </table>
    </div><br/><br/>
    <button id="clearPathButton">ì´ì „ ë£¨íŠ¸</button>
    <button id="showlist">ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</button>
    <br/><br/>
    <!-- ì‚°ì±… ê±°ë¦¬ -->
    <label for="routedistance">ì‚°ì±… ê±°ë¦¬</label>
    <span id="routedistance" style="display: inline-block;"></span><br/><br/>
</div><br/>
<!-- ë²„íŠ¼ë“¤ -->
<div class="buttons">
    <button id="savePathButton">ì¼ì • ìƒì„±</button>
    <button id="updateScheduleBtn" style="display: none">ì¼ì • ìˆ˜ì •</button>
</div>
<script>
    let map;
    let marker;
    let polyline; // Polyline ê°ì²´ ì¶”ê°€
    let path = []; // ê²½ë¡œë¥¼ ì €ì¥í•  ë°°ì—´
    let walks = [];
    let isAscending = true; // ì •ë ¬ ë°©í–¥ì„ ì¶”ì í•˜ê¸° ìœ„í•œ ë³€ìˆ˜
    let w1memberId = [[${member.id}]];
    function initMap1() {
        const latitude = [[${gpsCheck.latitude}]];
        const longitude = [[${gpsCheck.longitude}]];
        const initialPosition = { lat: latitude, lng: longitude };
        map = new google.maps.Map(document.getElementById("walkingTrailMap"), {
            center: initialPosition,
            zoom: 15,
        });
        marker = new google.maps.Marker({
            position: initialPosition,
            map: map,
            title: "My location",
        });
        // Polyline ê°ì²´ ìƒì„±
        polyline = new google.maps.Polyline({
            path: path,
            geodesic: true,
            strokeColor: '#FF0000',
            icons: [{
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 3,
                    strokeColor: '#0000FF',
                },
                offset: '100%',
                repeat: '200px' // í™”ì‚´í‘œë¥¼ ê²½ë¡œë¥¼ ë”°ë¼ 20px ê°„ê²©ìœ¼ë¡œ ë°˜ë³µ
            }],
        });
        polyline.setMap(map); // ì§€ë„ì— polyline ì¶”ê°€
        // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        map.addListener('click', (event) => {
            addLatLng(event.latLng);
        });
        // ê²½ë¡œ ì§€ìš°ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById("clearPathButton").addEventListener("click", clearPath);
        document.getElementById("savePathButton").addEventListener("click", function() {
            // ì…ë ¥ í•„ë“œì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
            const routeName = document.getElementById("routeName").value;
            const scheduleDate = document.getElementById("scheduleDate").value;
            const routedistanceText = document.getElementById("routedistance").textContent; // "2.5 km"
            const routedistance = parseFloat(routedistanceText.match(/[0-9.]+/)[0]);

            console.log(routeName);
            console.log(scheduleDate);
            console.log(routedistanceText);
            console.log(routedistance);

            const data = JSON.stringify({ path: path });
            console.log(data);

            // ìƒˆë¡œìš´ Walk ê°ì²´ ìƒì„±
            const walkData = {
                memberId: w1memberId,
                routeName: routeName,
                purchaseDate: scheduleDate,
                routePicture: data,
                routedistance: routedistance // ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜
            };
            console.log(walkData);

            // AJAX ìš”ì²­ì„ ë³´ë‚´ê¸°
            fetch('/usr/walk/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(walkData) // Walk ê°ì²´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
            })
                .then(response => {
                    if (response.ok) {
                        return response.text(); // ì„±ê³µì ì¸ ì‘ë‹µ
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(data => {
                    console.log('ì„±ê³µ:', data); // ì„±ê³µ ë©”ì‹œì§€ ì¶œë ¥
                    window.location.reload();
                    document.getElementById("addRoutePopup").style.display = "none"; // íŒì—… ë‹«ê¸°
                })
                .catch((error) => {
                    console.error('ì‹¤íŒ¨:', error); // ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
                    alert('ì¼ì • ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        });
        document.getElementById("closeRoutePopup").addEventListener("click", function() {
            document.getElementById("addRoutePopup").style.display = "none";
        });
    }
    // í´ë¦­ëœ ìœ„ì¹˜ë¥¼ polyline ê²½ë¡œì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function addLatLng(location) {
        path.push(location);
        polyline.setPath(path);
        updateDistance(); // ê²½ë¡œê°€ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ ê±°ë¦¬ ê³„ì‚°
    }
    function updateDistance() {
        let totalDistance = 0;
        // ë‘ ì¢Œí‘œ ê°„ì˜ ê±°ë¦¬ ê³„ì‚° ë° í•©ì‚°
        for (let i = 0; i < path.length - 1; i++) {
            totalDistance += google.maps.geometry.spherical.computeDistanceBetween(path[i], path[i + 1]);
        }
        // ê±°ë¦¬ í‘œì‹œ (ë¯¸í„°ë¥¼ í‚¬ë¡œë¯¸í„°ë¡œ ë³€í™˜)
        const distanceInKm = (totalDistance / 1000).toFixed(2);
        document.getElementById("routedistance").innerText = `${distanceInKm} km`;
    }
    // ê²½ë¡œë¥¼ ì§€ìš°ëŠ” í•¨ìˆ˜
    function clearPath() {
        if (path.length > 0) {
            path.pop(); // ë§ˆì§€ë§‰ ì¢Œí‘œ ì œê±°
            polyline.setPath(path); // í´ë¦¬ë¼ì¸ì— ìƒˆë¡œìš´ ê²½ë¡œ ì„¤ì •
            updateDistance();
        }
    }
    function savePathToLocalStorage() {
        const pathCoordinates = path.map(point => ({ lat: point.lat(), lng: point.lng() }));
        localStorage.setItem("savedPath", JSON.stringify(pathCoordinates));
        alert("Path saved successfully!");
    }
    function loadPathFromLocalStorage() {
        const savedPath = JSON.parse(localStorage.getItem("savedPath"));
        if (savedPath && savedPath.length > 0) {
            path = savedPath.map(coord => new google.maps.LatLng(coord.lat, coord.lng));
            polyline.setPath(path);
            updateDistance(); // ë¡œë“œëœ ê²½ë¡œì˜ ê±°ë¦¬ ì—…ë°ì´íŠ¸
            console.log(path);
        } else {
            alert("No path found in local storage.");
        }
    }
    function searchLocation() {
        const location = document.getElementById("locationInput").value;
        if (!location) {
            alert("Please enter a location.");
            return;
        }
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({address: location}, (results, status) => {
            if (status === "OK" && results[0]) {
                const position = results[0].geometry.location;
                map.setCenter(position);
                map.setZoom(15);
                marker.setPosition(position);
                marker.setTitle(location);

                // ì˜ˆì‹œ ì‚¬ìš©
                const latitude = position.lat(); // ì‹¤ì œ ìœ„ì¹˜ê°’
                const longitude = position.lng(); // ì‹¤ì œ ìœ„ì¹˜ê°’
                var gridCoordinates = convertLatLngToGrid(latitude, longitude);
                getWeatherInfo(gridCoordinates.nx, gridCoordinates.ny); // ë‚ ì”¨ ì •ë³´ ìš”ì²­
            } else {
                alert("Geocode was not successful for the following reason: " + status);
            }
        });
    }
    // ìœ„ì¹˜ ì…ë ¥ í•„ë“œì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById("locationInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            searchLocation();
        }
    });
    document.addEventListener("DOMContentLoaded", function() {
        fetchWalks(w1memberId);
    });
    function renderWalks(walksData) {
        const tableBody = document.querySelector("#WalkingTable tbody");
        tableBody.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš©ì„ ì§€ì›ë‹ˆë‹¤.

        walksData.forEach(item => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td class="ellipsis">${item.routeName}</td>
            <td>${item.purchaseDate}</td>
            <td>${item.routedistance}Km</td>
            <td>
            <button class="modify-btn"
                        data-route-name="${item.routeName}"
                        data-purchase-date="${item.purchaseDate}"
                        data-route-distance="${item.routedistance}">ğŸ”§</button></td>
            <td>

        `;

            tableBody.appendChild(row);
        });

        const modifyButtons = document.querySelectorAll(".modify-btn");
        modifyButtons.forEach(button => {
            button.addEventListener("click", function (event) {
                event.stopPropagation();
                // ë²„íŠ¼ì— ì„¤ì •ëœ ë°ì´í„° ì†ì„±ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
                const routeName = this.getAttribute("data-route-name");
                const purchaseDate = this.getAttribute("data-purchase-date");


            });
        });
    }
    function sortByColumn(walksData, column, isAscending) {
        return walksData.sort((a, b) => {
            let valueA = a[column] || '';  // undefined ì²˜ë¦¬
            let valueB = b[column] || '';

            // ë‚ ì§œ í˜•ì‹ì¼ ê²½ìš° ë¹„êµ ë°©ë²• ë³€ê²½
            if (column === 'purchaseDate') {
                valueA = valueA ? new Date(valueA) : new Date();
                valueB = valueB ? new Date(valueB) : new Date();
            }

            // ì •ë ¬ ë¡œì§ (ì˜¤ë¦„ì°¨ìˆœ ë˜ëŠ” ë‚´ë¦¼ì°¨ìˆœ)
            if (valueA < valueB) return isAscending ? -1 : 1;
            if (valueA > valueB) return isAscending ? 1 : -1;
            return 0;
        });
    }
    currentSortColumn = 'purchaseDate'; // ì´ˆê¸° ì •ë ¬ ì—´

    const arrows = {
        routeName: document.getElementById("routeNameArrow"),
        purchaseDate: document.getElementById("purchaseDateArrow"),
        routedistance: document.getElementById("routedistanceArrow"),
    };

    // í™”ì‚´í‘œ ì´ˆê¸°í™” í•¨ìˆ˜
    function resetArrows() {
        for (const key in arrows) {
            arrows[key].textContent = ''; // ëª¨ë“  í™”ì‚´í‘œ ì´ˆê¸°í™”
            arrows[key].classList.remove('visible');
        }
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜
    function init() {
        resetArrows(); // í™”ì‚´í‘œ ì´ˆê¸°í™”
        arrows.purchaseDate.textContent = 'â–¼'; // êµ¬ë§¤ì¼ í™”ì‚´í‘œ í‘œì‹œ
        arrows.purchaseDate.classList.add('visible'); // í™”ì‚´í‘œ ë³´ì´ê¸°
        const sortedWalks = sortByColumn(walks, currentSortColumn, isAscending); // ì •ë ¬
        renderWalks(sortedWalks); // ì •ë ¬ëœ ë°ì´í„° ë Œë”ë§
    }

    init(); // ì´ˆê¸°í™” í˜¸ì¶œ

    // ì‚°ì±…ëª… ì •ë ¬
    document.getElementById("routeNameHeader").addEventListener("click", () => {
        resetArrows(); // í™”ì‚´í‘œ ì´ˆê¸°í™”
        isAscending = currentSortColumn !== 'routeName' || !isAscending; // ì •ë ¬ ë°©í–¥ ê²°ì •
        currentSortColumn = 'routeName';
        arrows.routeName.textContent = isAscending ? 'â–¼' : 'â–²'; // í™”ì‚´í‘œ í‘œì‹œ
        arrows.routeName.classList.add('visible'); // í™”ì‚´í‘œ ë³´ì´ê¸°
        const sortedWalks = sortByColumn(walks, 'routeName', isAscending); // ì •ë ¬
        renderWalks(sortedWalks); // ì •ë ¬ëœ ë°ì´í„° ë Œë”ë§
    });


    // ì‚°ì±…ë‚ ì§œ ì •ë ¬
    document.getElementById("purchaseDateHeader").addEventListener("click", () => {
        resetArrows(); // í™”ì‚´í‘œ ì´ˆê¸°í™”
        isAscending = currentSortColumn !== 'purchaseDate' || !isAscending; // ì •ë ¬ ë°©í–¥ ê²°ì •
        currentSortColumn = 'purchaseDate';
        arrows.purchaseDate.textContent = isAscending ? 'â–¼' : 'â–²'; // í™”ì‚´í‘œ í‘œì‹œ
        arrows.purchaseDate.classList.add('visible'); // í™”ì‚´í‘œ ë³´ì´ê¸°
        const sortedWalks = sortByColumn(walks, 'purchaseDate', isAscending); // ì •ë ¬
        renderWalks(sortedWalks); // ì •ë ¬ëœ ë°ì´í„° ë Œë”ë§
    });

    // ì‚°ì±…ê±°ë¦¬ ì •ë ¬
    document.getElementById("routedistanceHeader").addEventListener("click", () => {
        resetArrows(); // í™”ì‚´í‘œ ì´ˆê¸°í™”
        isAscending = currentSortColumn !== 'routedistance' || !isAscending; // ì •ë ¬ ë°©í–¥ ê²°ì •
        currentSortColumn = 'routedistance';
        arrows.routedistance.textContent = isAscending ? 'â–¼' : 'â–²'; // í™”ì‚´í‘œ í‘œì‹œ
        arrows.routedistance.classList.add('visible'); // í™”ì‚´í‘œ ë³´ì´ê¸°
        const sortedWalks = sortByColumn(walks, 'routedistance', isAscending); // ì •ë ¬
        renderWalks(sortedWalks); // ì •ë ¬ëœ ë°ì´í„° ë Œë”ë§
    });

    // í’ˆëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function fetchWalks(w1memberId) {
        fetch(`/usr/walk/get?memberId=`+w1memberId) // memberId ê°’ì„ URLì— ì¶”ê°€
            .then(response => {
                if (!response.ok) {
                    throw new Error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(data => {
                walks = data; // ë°ì´í„°ë¥¼ essentialsì— í• ë‹¹

                // ê¸°ë³¸ì ìœ¼ë¡œ êµ¬ë§¤ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
                walks = sortByColumn(walks, 'purchaseDate', true); // ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                renderWalks(walks); // ë°ì´í„°ë¥¼ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
            })
            .catch(error => {
                console.error('Error fetching essentials:', error);
            });
    }
</script>
</body>
</html>